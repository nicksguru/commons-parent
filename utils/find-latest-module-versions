#!/usr/bin/env bash
#
# Finds the most recently released (which is NOT always the same as 'the latest') Maven module versions on Maven Central
# and compares them to those listed below.
#
set -e
DIR=$(dirname "$0")

declare -a REPORT

#
# Adds to $REPORT.
#
function check_module_version() {
    local module=${1?Missing module definition}
    local i=${2?Missing module number}

    # parse 'groupId:artifactId:currentVersion'
    if ! [[ "$module" =~ ^([^:]+):([^:]+):(.+)$ ]]; then
        echo "Invalid entry: '$module'"
        exit 1
    fi

    local group_id=${BASH_REMATCH[1]}
    local artifact_id=${BASH_REMATCH[2]}
    local old_version=${BASH_REMATCH[3]}

    printf "[%2d/%d] %s:%s\n" "$((i + 1))" "${#CURRENT_MODULE_VERSIONS[@]}" "${group_id}" "${artifact_id}"
    # Maven Central Search (JSON) API is unstable as to reporting the latest version, unlike this file
    local new_version
    new_version=$(curl -sSL "https://repo.maven.apache.org/maven2/${group_id//.//}/$artifact_id/maven-metadata.xml" \
        | grep --only-matching -E '<version>.+?</version>' \
        | tail -n 1 \
        | sed -Ee's#<version>(.+?)</version>#\1#')
    #echo "$new_version"
    
    if [ -z "$new_version" ]; then
        REPORT+=("")
        REPORT+=("* $module")
        REPORT+=("    [ERROR] Version not found, invalid API request?")
    elif [ "$new_version" != "$old_version" ]; then
        REPORT+=("")
        REPORT+=("* $module")
        REPORT+=("    [INFO ] Latest version released: $new_version")
        
        declare -i old_version_major
        declare -i old_version_minor
        declare -i old_version_patch

        # parse '1.2.3whatever'
        if [[ "$old_version" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
            old_version_major=${BASH_REMATCH[1]}
            old_version_minor=${BASH_REMATCH[2]}
            old_version_patch=${BASH_REMATCH[3]}
        # parse '1.2whatever' (no patch segment)
        elif [[ "$old_version" =~ ^([0-9]+)\.([0-9]+) ]]; then
            old_version_major=${BASH_REMATCH[1]}
            old_version_minor=${BASH_REMATCH[2]}
            old_version_patch=0
        # parse '1whatever' (no minor version)
        elif [[ "$old_version" =~ ^([0-9]+) ]]; then
            old_version_major=${BASH_REMATCH[1]}
            old_version_minor=0
            old_version_patch=0
        else
            old_version_major=0
            old_version_minor=0
            old_version_patch=0
        fi

        declare -i new_version_major
        declare -i new_version_minor
        declare -i new_version_patch

        # parse '1.2.3whatever'
        if [[ "$new_version" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
            new_version_major=${BASH_REMATCH[1]}
            new_version_minor=${BASH_REMATCH[2]}
            new_version_patch=${BASH_REMATCH[3]}
        # parse '1.2whatever' (no patch segment)
        elif [[ "$new_version" =~ ^([0-9]+)\.([0-9]+) ]]; then
            new_version_major=${BASH_REMATCH[1]}
            new_version_minor=${BASH_REMATCH[2]}
            new_version_patch=0
        # parse '1whatever' (no minor version)
        elif [[ "$new_version" =~ ^([0-9]+) ]]; then
            new_version_major=${BASH_REMATCH[1]}
            new_version_minor=0
            new_version_patch=0
        else
            new_version_major=0
            new_version_minor=0
            new_version_patch=0
        fi

        local has_inconsistency=0

        # in new (a.b.c) vs. old (d.e.f), a must be greater than or equal to d
        if [ $new_version_major -lt $old_version_major ]; then
            has_inconsistency=1
            REPORT+=("    [WARN ] Search API inconsistency: latest major version ($new_version_major) is smaller than yours ($old_version_major). Please check the latest version on Maven Central manually.")
        # if major versions are equal, sanitize minor patch versions
        elif [ $new_version_major -eq $old_version_major ]; then
            # in new (a.b.c) vs. old (d.e.f), b must be greater than or equal to e
            if [ $new_version_minor -lt $old_version_minor ]; then
                has_inconsistency=1
                REPORT+=("    [WARN ] Search API inconsistency: latest minor version ($new_version_minor) is smaller than yours ($old_version_minor). Please check the latest version on Maven Central manually.")
            # if major and minor versions are equal, sanitize patch versions
            elif [ $new_version_minor -eq $old_version_minor ]; then
                # in new (a.b.c) vs. old (d.e.f), c must be greater than or equal to f
                if [ "$new_version_patch" -lt "$old_version_patch" ]; then
                    has_inconsistency=1
                    REPORT+=("    [WARN ] Search API inconsistency: latest patch version ($new_version_patch) is smaller than yours ($old_version_patch). Please check the latest version on Maven Central manually.")
                fi
            fi
        fi

        # debug version parsing
        if [ "$has_inconsistency" -ne 0 ]; then
            REPORT+=("    [DEBUG] Latest version parsed: $new_version -> major=$new_version_major, minor=$new_version_minor, patch=$new_version_patch")
            REPORT+=("    [DEBUG] Your version parsed: $old_version -> major=$old_version_major, minor=$old_version_minor, patch=$old_version_patch")
        fi
    fi
}

declare -a CURRENT_MODULE_VERSIONS
# read current module versions
while read -r line; do
    # remove '#'-style comments
    line=$(echo "$line" | sed -Ee 's/^[[:space:]]*#.*$//')
    # remove blank lines
    line=$(echo "$line" | sed -Ee 's/^[[:space:]]+$//')

    if [ -n "$line" ]; then
        CURRENT_MODULE_VERSIONS+=("$line")
    fi
done <"$DIR/modules.lst"

echo "Checking latest module versions..."
#echo "${CURRENT_MODULE_VERSIONS[@]}"
declare -i i=0

for module in "${CURRENT_MODULE_VERSIONS[@]}"; do
    check_module_version "$module" "$i"
    i=$((i + 1))
done

echo
echo "Modules having newer versions:"
IFS=$'\n'
echo "${REPORT[*]}"
